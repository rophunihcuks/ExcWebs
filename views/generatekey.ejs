<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title><%= title || 'ExHub - Generate Key' %></title>
  <meta name="viewport" content="width=device-box, initial-scale=1" />
  <!-- pastikan file ada di public/css/main.css -->
  <link rel="stylesheet" href="/css/main.css" />
</head>
<body class="page-dark">
  <div class="key-page">
    <div class="key-shell">
      <!-- ================= HEADER / HERO ================= -->
      <header class="key-header">
        <div class="key-header-main">
          <h1 class="key-title">ExHub - Generate Key</h1>
          <p class="key-subtitle">
            Complete the step, then generate your ExHub key for loader / script.
            Keys are valid for up to
            <strong><%= (typeof defaultKeyHours !== 'undefined' ? defaultKeyHours : 24) %> hours</strong>.
          </p>
        </div>

        <%
          // State header kanan:
          // - 'start'  : tombol Start (belum lewat iklan / checkpoint belum OK)
          // - 'timer'  : jika suatu saat mau pakai timer (headerState='timer' + headerTimerLabel)
          // - 'done'   : checkpoint ads sudah OK → siap generate key
          const _headerState =
            (typeof headerState !== 'undefined' && headerState) || 'start';
          const _timerLabel =
            (typeof headerTimerLabel !== 'undefined' && headerTimerLabel) || null;

          // Progress ala Luarmor (1 step):
          //  - 0/1 jika belum checkpoint (belum klik Start / belum kembali dengan ?done=1)
          //  - 1/1 jika checkpoint sudah OK (headerState='done')
          //  Setelah berhasil generate key, server akan reset checkpoint,
          //  sehingga load berikutnya kembali 0/1 dan harus Start lagi.
          const totalSteps = 1;
          const stepsDone = _headerState === 'done' ? totalSteps : 0;
          const pctRaw = (stepsDone / totalSteps) * 100;
          const pct = Math.max(0, Math.min(100, Math.round(pctRaw)));
        %>

        <div class="key-header-progress">
          <div class="key-progress-label">
            Progress:&nbsp;<span><%= stepsDone %>/<%= totalSteps %></span>
          </div>
          <div class="key-progress-bar">
            <div class="key-progress-bar-fill" style="width: <%= pct %>%"></div>
          </div>
        </div>

        <div class="key-header-actions">
          <% if (_headerState === 'timer' && _timerLabel) { %>
            <!-- Mode timer (opsional) -->
            <button type="button" class="key-btn key-btn-outline" disabled>
              <span class="key-btn-icon">⏳</span>
              <span><%= _timerLabel %></span>
            </button>
          <% } else if (_headerState === 'done') { %>
            <!-- Mode DONE: iklan / checkpoint sudah selesai -->
            <button type="button" class="key-btn key-btn-outline" disabled>
              <span class="key-btn-icon">✔</span>
              <span>Done</span>
            </button>
          <% } else { %>
            <!-- Default: tombol Start → Linkvertise / ads -->
            <a
              href="<%= adsUrl %>"
              class="key-btn key-btn-primary"
              target="_blank"
              rel="noopener noreferrer"
            >
              <span class="key-btn-icon">⧉</span>
              <span>Start</span>
            </a>
          <% } %>
        </div>
      </header>

      <!-- ALERT ERROR (opsional) -->
      <% if (errorMessage) { %>
        <div class="key-alert key-alert-error">
          <span><%= errorMessage %></span>
        </div>
      <% } %>

      <!-- ================= INSTRUCTIONS ================= -->
      <section class="key-instructions">
        <h2 class="key-section-title">How it works</h2>
        <ol class="key-step-list">
          <li>Click <strong>Start</strong> to open ads / link-hub in a new tab.</li>
          <li>Complete all required steps in Linkvertise until it redirects back here.</li>
          <li>Return to this page: <code><%= (typeof baseUrl !== 'undefined' ? baseUrl : requestHost || '') %>/generatekey</code>.</li>
          <li>Click <strong>Get A New Key</strong> below to generate your token, then copy it into your ExHub loader / script.</li>
        </ol>
        <p class="key-note">
          Max
          <strong><%= (typeof maxKeys !== 'undefined' ? maxKeys : 1) %> active keys</strong>
          per IP. Expired / deleted keys will not count against this limit.
        </p>
      </section>

      <!-- ================= BODY: LIST KEYS ================= -->
      <section class="key-body">
        <div class="key-body-header">
          <div>
            <h2 class="key-section-title">
              Your Keys (<%= (keys && keys.length) || 0 %>/<%= (typeof maxKeys !== 'undefined' ? maxKeys : 1) %>)
            </h2>
            <p class="key-body-subtitle">
              Copy one active key and paste it into your loader or Roblox script.
            </p>
          </div>

          <!-- Form kecil (opsional) untuk filter/refresh by userId -->
          <form
            action="/generatekey"
            method="GET"
            class="key-new-form"
          >
            <input
              type="text"
              name="userId"
              class="key-input"
              placeholder="Optional: Roblox UserId"
              value="<%= typeof currentUserId !== 'undefined' ? currentUserId : '' %>"
              autocomplete="off"
            />
            <button type="submit" class="key-btn key-btn-ghost">
              Refresh
            </button>
          </form>
        </div>

        <% if (keys && keys.length > 0) { %>
          <div class="key-table-wrapper">
            <table class="key-table">
              <thead>
                <tr>
                  <th>Your Keys</th>
                  <th>Time Left</th>
                  <th>Status</th>
                  <th class="key-col-actions">Actions</th>
                </tr>
              </thead>
              <tbody>
                <% keys.forEach(function(k) { %>
                  <tr>
                    <td class="key-cell-token">
                      <code class="key-token"><%= k.token %></code>
                    </td>
                    <td><%= k.timeLeftLabel || '-' %></td>
                    <td>
                      <%
                        var statusLabel = k.status || 'Active';
                        var badgeClass =
                          statusLabel === 'Active'
                            ? 'badge-success'
                            : statusLabel === 'Expired'
                            ? 'badge-muted'
                            : 'badge-danger';
                      %>
                      <span class="badge <%= badgeClass %>"><%= statusLabel %></span>
                    </td>
                    <td class="key-cell-actions">
                      <button
                        type="button"
                        class="key-btn key-btn-xs key-btn-outline"
                        data-copy="<%= k.token %>"
                      >
                        Copy
                      </button>
                    </td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
        <% } else { %>
          <div class="key-empty">
            <p>
              No keys for this IP yet. Follow the steps above, complete ads / link-hub,
              then click <strong>Get A New Key</strong> below.
            </p>
          </div>
        <% } %>
      </section>

      <!-- ================= CTA: GET A NEW KEY ================= -->
      <section class="key-body">
        <%
          // endpoint untuk generate key, default /getkey/new
          const newKeyAction =
            (typeof keyAction !== 'undefined' && keyAction) ? keyAction : '/getkey/new';
          const canGenerate =
            (typeof allowGenerate === 'boolean') ? allowGenerate : true;
        %>

        <div style="margin-top: 18px; display: flex; justify-content: center;">
          <form
            action="<%= newKeyAction %>"
            method="POST"
            style="display: inline-flex; flex-direction: column; align-items: center; gap: 8px;"
          >
            <% if (typeof currentUserId !== 'undefined' && currentUserId) { %>
              <input type="hidden" name="userId" value="<%= currentUserId %>" />
            <% } %>

            <button
              type="submit"
              class="key-btn key-btn-ghost"
              style="min-width: 220px; justify-content: center;"
              <%= canGenerate ? '' : 'disabled' %>
            >
              <span class="key-btn-icon">＋</span>
              <span>Get A New Key</span>
            </button>

            <% if (!canGenerate) { %>
              <p class="key-note" style="text-align:center; max-width: 360px;">
                Complete the <strong>Start</strong> step in Linkvertise first.
                After redirecting back here, this button will be unlocked.
              </p>
            <% } %>
          </form>
        </div>
      </section>
    </div>
  </div>

  <!-- ================= SCRIPT: COPY BUTTON ================= -->
  <script>
    (function () {
      var buttons = document.querySelectorAll('[data-copy]');
      if (!buttons || !buttons.length) return;

      buttons.forEach(function (btn) {
        btn.addEventListener('click', function () {
          var token = btn.getAttribute('data-copy') || '';
          if (!token) return;

          if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard
              .writeText(token)
              .then(function () {
                var prev = btn.textContent;
                btn.textContent = 'Copied';
                setTimeout(function () {
                  btn.textContent = prev;
                }, 1200);
              })
              .catch(function () {
                var prev = btn.textContent;
                btn.textContent = 'Failed';
                setTimeout(function () {
                  btn.textContent = prev;
                }, 1200);
              });
          } else {
            // Fallback lama (execCommand)
            var dummy = document.createElement('textarea');
            dummy.value = token;
            dummy.style.position = 'fixed';
            dummy.style.opacity = '0';
            document.body.appendChild(dummy);
            dummy.select();
            try {
              document.execCommand('copy');
            } catch (e) {
              console.warn('Copy failed', e);
            }
            document.body.removeChild(dummy);
          }
        });
      });
    })();
  </script>
</body>
</html>
