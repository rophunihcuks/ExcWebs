<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title><%= title || 'ExHub - Generate Key' %></title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link rel="icon" type="image/png" href="/img/ExLogo2.png" />
  <link rel="stylesheet" href="/css/main.css" />
</head>
<body class="page-dark">
  <noscript>
    <div class="key-alert key-alert-error" style="margin:16px;">
      JavaScript is required on this page to copy keys. Please enable JavaScript.
    </div>
  </noscript>

  <div class="key-page">
    <div class="key-shell">
      <!-- ================= HEADER / HERO ================= -->
      <header class="key-header">
        <div class="key-header-main">
          <h1 class="key-title">ExHub - Generate Key</h1>
          <p class="key-subtitle">
            Complete the step, then generate your ExHub key for loader / script.
            Keys are valid for up to
            <strong><%= (typeof defaultKeyHours !== 'undefined' ? defaultKeyHours : 24) %> hours</strong>.
          </p>
        </div>

        <%
          // State header kanan:
          // - 'start'  : tombol Start (belum lewat iklan / checkpoint belum OK)
          // - 'timer'  : jika suatu saat mau pakai timer (headerState='timer' + headerTimerLabel)
          // - 'done'   : checkpoint ads sudah OK → siap generate key
          const _headerState =
            (typeof headerState !== 'undefined' && headerState) || 'start';
          const _timerLabel =
            (typeof headerTimerLabel !== 'undefined' && headerTimerLabel) || null;

          // Progress ala Luarmor (1 step):
          //  - 0/1 jika belum checkpoint
          //  - 1/1 jika checkpoint sudah OK (headerState='done')
          const totalSteps = 1;
          const stepsDone = _headerState === 'done' ? totalSteps : 0;
          const pctRaw = (stepsDone / totalSteps) * 100;
          const pct = Math.max(0, Math.min(100, Math.round(pctRaw)));

          // ================= START URL LOGIC =================
          // Server bisa kirim:
          //  - adsUrl = full Linkvertise URL (lama)
          //  - adsUrl = /generatekey/start?... (baru)
          // Di sisi view, kita pastikan:
          //  - kalau adsUrl sudah internal (/generatekey/...), pakai apa adanya
          //  - kalau masih Linkvertise, override jadi /generatekey/start (+ userId)
          const _adsUrl    = (typeof adsUrl !== 'undefined' && adsUrl) ? String(adsUrl) : '';
          const _currUid   = (typeof currentUserId !== 'undefined' && currentUserId)
            ? String(currentUserId).trim()
            : '';
          const _uidQuery  = _currUid ? ('?userId=' + encodeURIComponent(_currUid)) : '';
          let   startUrl   = _adsUrl;

          if (!_adsUrl || _adsUrl.indexOf('/generatekey/') === -1) {
            // adsUrl kosong atau masih URL eksternal → pakai route internal start
            startUrl = '/generatekey/start' + _uidQuery;
          }

          // ================= KEY ACTION / RENEW ACTION =================
          // Disiapkan di sini supaya bisa dipakai di table dan CTA bawah
          const newKeyAction =
            (typeof keyAction !== 'undefined' && keyAction) ? keyAction : '/getkey/new';
          const canGenerate =
            (typeof allowGenerate === 'boolean') ? allowGenerate : true;
          const renewAction =
            (typeof renewAction !== 'undefined' && renewAction) ? renewAction : '/getkey/renew';
        %>

        <div class="key-header-progress">
          <div class="key-progress-label">
            Progress:&nbsp;<span><%= stepsDone %>/<%= totalSteps %></span>
          </div>
          <div class="key-progress-bar">
            <div class="key-progress-bar-fill" style="width: <%= pct %>%"></div>
          </div>
        </div>

        <div class="key-header-actions">
          <% if (_headerState === 'timer' && _timerLabel) { %>
            <!-- Mode timer (opsional) -->
            <button
              type="button"
              class="key-btn key-btn-outline"
              disabled
              aria-disabled="true"
            >
              <span class="key-btn-icon">⏳</span>
              <span><%= _timerLabel %></span>
            </button>
          <% } else if (_headerState === 'done') { %>
            <!-- Mode DONE: iklan / checkpoint sudah selesai -->
            <button
              type="button"
              class="key-btn key-btn-outline"
              disabled
              aria-disabled="true"
            >
              <span class="key-btn-icon">✔</span>
              <span>Done</span>
            </button>
          <% } else { %>
            <!-- Default: tombol Start → route internal /generatekey/start (TAB YANG SAMA) -->
            <a
              href="<%= startUrl %>"
              class="key-btn key-btn-primary"
              rel="noopener noreferrer"
            >
              <span class="key-btn-icon">⧉</span>
              <span>Start</span>
            </a>
          <% } %>
        </div>
      </header>

      <!-- ALERT ERROR (opsional) -->
      <% if (errorMessage) { %>
        <div class="key-alert key-alert-error">
          <span><%= errorMessage %></span>
        </div>
      <% } %>

      <!-- ================= INSTRUCTIONS ================= -->
      <section class="key-instructions">
        <h2 class="key-section-title">How it works</h2>
        <ol class="key-step-list">
          <li>Click <strong>Start</strong> to open the ads</li>
          <li>Complete all required steps in Linkvertise until it redirects back here.</li>
          <li>
            After redirect, you should land on:
            <code>
              <%= (typeof baseUrl !== 'undefined' && baseUrl)
                    ? baseUrl + '/generatekey'
                    : ((requestHost || '') ? ('https://' + requestHost + '/generatekey') : '/generatekey') %>
            </code>.
          </li>
          <li>On that page, click <strong>Get A New Key</strong> to generate your token, then copy it into your ExHub loader / script.</li>
        </ol>
        <p class="key-note">
          Max
          <strong><%= (typeof maxKeys !== 'undefined' ? maxKeys : 1) %> active keys</strong>
          per IP. Expired keys will not count against this limit.
        </p>
        <% if (typeof currentUserId !== 'undefined' && currentUserId) { %>
          <p class="key-note">
            Current Roblox UserId filter:
            <code><%= currentUserId %></code>
          </p>
        <% } %>
      </section>

      <!-- ================= BODY: LIST KEYS ================= -->
      <section class="key-body">
        <div class="key-body-header">
          <div>
            <h2 class="key-section-title">
              Your Keys (<%= (keys && keys.length) || 0 %>/<%= (typeof maxKeys !== 'undefined' ? maxKeys : 1) %>)
            </h2>
            <p class="key-body-subtitle">
              Copy one active key and paste it into your loader or Roblox script.
            </p>
          </div>

          <!-- Form kecil untuk filter/refresh by userId -->
          <form
            action="/generatekey"
            method="GET"
            class="key-new-form"
            autocomplete="off"
            novalidate
          >
            <input
              type="text"
              name="userId"
              class="key-input"
              placeholder="Optional: Roblox UserId"
              value="<%= typeof currentUserId !== 'undefined' ? currentUserId : '' %>"
              autocomplete="off"
              inputmode="numeric"
            />
            <button type="submit" class="key-btn key-btn-ghost">
              Refresh
            </button>
          </form>
        </div>

        <% if (keys && keys.length > 0) { %>
          <div class="key-table-wrapper">
            <table class="key-table">
              <thead>
                <tr>
                  <th>Your Keys</th>
                  <th>Time Left</th>
                  <th>Status</th>
                  <th class="key-col-actions">Actions</th>
                </tr>
              </thead>
              <tbody>
                <% keys.forEach(function(k) { %>
                  <%
                    // Server disarankan kirim salah satu:
                    //  - k.expiresAtMs (ms sejak epoch)   ← rekomendasi
                    //  - k.expiresAt
                    //  - k.expiresAfter
                    var expireTs = k && (k.expiresAtMs || k.expiresAt || k.expiresAfter || null);

                    var statusLabel = k && k.status ? k.status : 'Active';
                    var badgeClass =
                      statusLabel === 'Active'
                        ? 'badge-success'
                        : statusLabel === 'Expired'
                        ? 'badge-muted'
                        : 'badge-danger';
                  %>
                  <tr
                    class="key-row"
                    data-status="<%= statusLabel %>"
                    <% if (expireTs) { %> data-expire-ts="<%= expireTs %>" <% } %>
                  >
                    <td class="key-cell-token">
                      <code class="key-token"><%= k.token %></code>
                    </td>

                    <!-- TIME LEFT: realtime countdown via JS -->
                    <td class="key-cell-time">
                      <span class="key-time-label">
                        <%= k.timeLeftLabel || (expireTs ? '' : '-') %>
                      </span>
                    </td>

                    <!-- STATUS BADGE (bisa diupdate JS ketika countdown habis) -->
                    <td>
                      <span class="badge <%= badgeClass %> key-status-badge"><%= statusLabel %></span>
                    </td>

                    <!-- ACTIONS: Copy + (optional) Renew jika Expired -->
                    <td class="key-cell-actions">
                      <button
                        type="button"
                        class="key-btn key-btn-xs key-btn-outline"
                        data-copy="<%= k.token %>"
                      >
                        Copy
                      </button>

                      <% if (renewAction) { %>
                        <form
                          action="<%= renewAction %>"
                          method="POST"
                          class="key-renew-form"
                          data-renew-form="1"
                          style="<%= statusLabel === 'Expired' ? 'display:inline-flex; margin-left:6px;' : 'display:none; margin-left:6px;' %>"
                        >
                          <input type="hidden" name="token" value="<%= k.token %>" />
                          <% if (typeof currentUserId !== 'undefined' && currentUserId) { %>
                            <input type="hidden" name="userId" value="<%= currentUserId %>" />
                          <% } %>
                          <button
                            type="submit"
                            class="key-btn key-btn-xs key-btn-ghost"
                          >
                            Renew
                          </button>
                        </form>
                      <% } %>
                    </td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
        <% } else { %>
          <div class="key-empty">
            <p>
              No keys for this IP yet. Follow the steps above, complete ads / link-hub,
              then click <strong>Get A New Key</strong> below.
            </p>
          </div>
        <% } %>
      </section>

      <!-- ================= CTA: GET A NEW KEY ================= -->
      <section class="key-body">
        <div style="margin-top: 18px; display: flex; justify-content: center;">
          <form
            action="<%= newKeyAction %>"
            method="POST"
            style="display: inline-flex; flex-direction: column; align-items: center; gap: 8px;"
          >
            <% if (typeof currentUserId !== 'undefined' && currentUserId) { %>
              <input type="hidden" name="userId" value="<%= currentUserId %>" />
            <% } %>

            <button
              type="submit"
              class="key-btn key-btn-ghost"
              style="min-width: 220px; justify-content: center;"
              <%= canGenerate ? '' : 'disabled="disabled" aria-disabled="true"' %>
            >
              <span class="key-btn-icon">＋</span>
              <span>Get A New Key</span>
            </button>

            <% if (!canGenerate) { %>
              <p class="key-note" style="text-align:center; max-width: 360px;">
                Complete the <strong>Start</strong> step in Linkvertise first.
                After redirecting back here, this button will be unlocked.
              </p>
            <% } %>
          </form>
        </div>
      </section>
    </div>
  </div>

  <!-- ================= SCRIPT: COPY BUTTON ================= -->
  <script>
    (function () {
      var buttons = document.querySelectorAll('[data-copy]');
      if (!buttons || !buttons.length) return;

      function safeText(str, maxLen) {
        if (typeof str !== 'string') str = String(str || '');
        if (maxLen && maxLen > 0 && str.length > maxLen) {
          return str.slice(0, maxLen);
        }
        return str;
      }

      buttons.forEach(function (btn) {
        btn.addEventListener('click', function () {
          var token = btn.getAttribute('data-copy') || '';
          token = safeText(token, 256); // guard length

          if (!token) return;

          var prev = btn.textContent;

          if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard
              .writeText(token)
              .then(function () {
                btn.textContent = 'Copied';
                setTimeout(function () {
                  btn.textContent = prev;
                }, 1200);
              })
              .catch(function () {
                btn.textContent = 'Failed';
                setTimeout(function () {
                  btn.textContent = prev;
                }, 1200);
              });
          } else {
            // Fallback lama (execCommand)
            var dummy = document.createElement('textarea');
            dummy.value = token;
            dummy.setAttribute('readonly', '');
            dummy.style.position = 'fixed';
            dummy.style.opacity = '0';
            dummy.style.zIndex = '-1';
            document.body.appendChild(dummy);
            dummy.select();
            try {
              document.execCommand('copy');
            } catch (e) {
              console.warn('Copy failed', e);
            }
            document.body.removeChild(dummy);
          }
        });
      });
    })();
  </script>

  <!-- ================= SCRIPT: REALTIME TIME LEFT + RENEW ================= -->
  <script>
    (function () {
      var rows = document.querySelectorAll('.key-table tbody tr.key-row');
      if (!rows || !rows.length) return;

      function formatRemaining(ms) {
        if (!isFinite(ms)) return '-';
        if (ms <= 0) return 'Expired';

        var totalSec = Math.floor(ms / 1000);
        var d = Math.floor(totalSec / 86400);
        var h = Math.floor((totalSec % 86400) / 3600);
        var m = Math.floor((totalSec % 3600) / 60);
        var s = totalSec % 60;

        var parts = [];
        if (d > 0) parts.push(d + 'd');
        if (h > 0 || d > 0) parts.push(h + 'h');
        if (m > 0 || h > 0 || d > 0) parts.push(m + 'm');
        parts.push(s + 's');
        return parts.join(' ');
      }

      function tick() {
        var now = Date.now();

        rows.forEach(function (row) {
          var expireStr = row.getAttribute('data-expire-ts');
          if (!expireStr) return;

          var expireTs = parseInt(expireStr, 10);
          if (!expireTs || !isFinite(expireTs)) return;

          var timeCell = row.querySelector('.key-time-label');
          if (!timeCell) return;

          var diff = expireTs - now;
          timeCell.textContent = formatRemaining(diff);

          var statusBadge = row.querySelector('.key-status-badge');
          var renewForm   = row.querySelector('form[data-renew-form="1"]');

          if (diff <= 0) {
            // Sudah expired (atau lewat)
            if (statusBadge && !statusBadge.dataset.expiredSet) {
              statusBadge.textContent = 'Expired';
              statusBadge.classList.remove('badge-success');
              statusBadge.classList.remove('badge-danger');
              statusBadge.classList.add('badge-muted');
              statusBadge.dataset.expiredSet = '1';
            }

            if (renewForm && renewForm.style.display === 'none') {
              renewForm.style.display = 'inline-flex';
            }
          }
        });
      }

      tick();
      setInterval(tick, 1000);
    })();
  </script>

  <!-- Proteksi dasar: blokir klik kanan + beberapa shortcut DevTools -->
  <script src="/js/protect-devtools.js"></script>
</body>
</html>
